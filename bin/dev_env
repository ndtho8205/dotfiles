#!/usr/bin/env bash

set -o errexit
set -o errtrace
set -o nounset
set -o pipefail

INSTALLATION_DIR="$HOME/ProgramFiles"
TEMP_DIR=$(mktemp --directory --quiet)
PY3_VERSION="3.6.10"

trap _clean EXIT

main() {
  command=''
  _parse_params "$@"

  _setup_go_env
  _setup_rust_env
  _setup_node_env
  _setup_python_env
}

_print_usage() {
  cat <<EOF
usage: $(basename "$0") [OPTION] {install,update,list}

Install and update personal development environment.

Commands:
  install        Install development environment
  update         Update all packages
  list           List installed packages
Options:
  -h, --help     Show this help and exit
EOF
}

_parse_params() {
  if [[ $# -eq 0 ]]; then
    echo "No command/option specified."
    echo
    _print_usage
    exit 1
  fi

  local param

  while [[ $# -gt 0 ]]; do
    param="$1"
    shift

    case $param in
    install)
      command="install"
      ;;
    update)
      command="update"
      ;;
    list)
      command="list"
      ;;
    -h | --help)
      _print_usage
      exit 0
      ;;
    *)
      echo "error: unrecognized arguments: $param"
      exit 1
      ;;
    esac
  done
}

_clean() {
  rm -rf "$TEMP_DIR"
}

##################################################
## Programming Languages Development Environments
##################################################

_setup_go_env() {
  info "Setup Go development environment"

  local go_installation_dir go_latest_version go_filename

  go_installation_dir="$INSTALLATION_DIR/go"
  go_latest_version=$(wget --quiet --output-document=- 'https://golang.org/dl/?mode=json' | grep -oP '[0-9\.]+' | head -n 1)
  go_filename="go${go_latest_version}.linux-amd64.tar.gz"

  if [[ -d "$go_installation_dir" ]]; then
    rm -r "$go_installation_dir"
  else
    mkdir "$go_installation_dir"
  fi

  wget \
    --quiet \
    --show-progress \
    --output-document="$TEMP_DIR/$go_filename" \
    "https://dl.google.com/go/$go_filename"

  tar -xzf "$TEMP_DIR/$go_filename" -C "$INSTALLATION_DIR"
}

_setup_rust_env() {
  info "Rust development environment"

  case $command in
  install)
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
    ;;
  update)
    rustup update
    ;;
  esac
}

_setup_node_env() {
  info "Node.js development environment"

  case $command in
  install)
    curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -
    sudo apt-get install -y nodejs
    ;;
  update)
    sudo apt-get update
    sudo apt-get install --only-upgrade nodejs
    ;;
  esac
}

_setup_python_env() {
  info "Python development environment"
  case $command in
  install)
    sudo apt install -y --no-install-recommends \
      make build-essential libssl-dev zlib1g-dev libbz2-dev \
      libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev \
      xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev

    curl https://pyenv.run | bash
    export PYENV_ROOT="$HOME/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"

    pyenv install "$PY3_VERSION"
    pyenv global "$PY3_VERSION" system

    pip install --upgrade pip

    pip install pipx

    curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python

    pipx install black
    pipx install flake8
    pipx install pylint
    ;;
  update)
    pipx upgrade-all
    ;;
  esac
}

##################################################
## Docker
##################################################

_install_docker() {
  sudo apt purge docker docker-engine docker.io containerd runc

  sudo apt install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common

  curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -

  sudo add-apt-repository \
    "deb [arch=amd64] https://download.docker.com/linux/debian \
    $(lsb_release -cs) \
    stable"

  sudo apt-get update
  sudo apt-get install docker-ce docker-ce-cli containerd.io

  sudo groupadd docker
  sudo usermod -aG docker "$USER"
  newgrp docker

  sudo systemctl start docker

  pipx install docker-compose
}

##################################################
## CLI Tools
##################################################

_install_cli_tools() {
  cargo install tealdeer
  tldr --update

  cargo install --locked bat

  cargo install watchexec

  bash -c "$DOTFILES/vim/pack/plugins/start/fzf/install --bin"

  npm i -g markdownlint-cli prettier

  sudo apt install shellcheck
  GO111MODULE=on go get mvdan.cc/sh/v3/cmd/shfmt

  go get github.com/jesseduffield/lazydocker
}

##################################################
## GUI Tools
##################################################

_install_gui_tools() {
  #vscode
  :
}

##################################################
## VPN Tools
##################################################

_install_vpn_tools() {
  pyenv shell system

  sudo apt install --no-install-recommends openvpn dialog python3-pip python3-setuptools
  sudo pip3 install protonvpn-cli

  echo "Please login to ProtonVPN account at 'https://account.protonvpn.com/account'"
  echo "to get the OpenVPN credentials."
  xdg-open "https://account.protonvpn.com/"
  sudo protonvpn init

  pyenv shell --unset
}

##################################################
## Utility functions
##################################################

ta_normal='' ta_standout=''
fg_blue='' fg_red='' fg_green=''

ncolors=$(command -v tput >/dev/null && tput colors)
if test -n "$ncolors" && test "$ncolors" -ge 8; then
  ta_normal="$(tput sgr0)"
  ta_standout="$(tput smso)"

  fg_blue="$(tput setaf 4)"
  fg_red="$(tput setaf 1)"
  fg_green="$(tput setaf 2)"
fi

info() {
  printf "\\n${ta_standout}${fg_blue} INFO ${ta_normal} ${fg_blue}%s${ta_normal}\\n" "$1"
}

success() {
  printf "\\n${ta_standout}${fg_green} DONE ${ta_normal} ${fg_green}%s${ta_normal}\\n" "$1"
}

fail() {
  printf "\\n${ta_standout}${fg_red} FAIL ${ta_normal} ${fg_red}%s${ta_normal}\\n" "$1"
}

##################################################
##################################################

main "$@"
